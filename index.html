<!DOCTYPE HTML>
<!--
	Fractal by HTML5 UP
	html5up.net | @ajlkn
	Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
-->
<html>
	<head>
		<title>Compound.js</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
		<link rel="stylesheet" href="assets/css/main.css" />
		<noscript><link rel="stylesheet" href="assets/css/noscript.css" /></noscript>
	</head>
	<body class="is-preload">

		<!-- Header -->
			<header id="header">
				<div class="content">
					<img src="/images/compound-logo.svg" width="127" height="27">
					<p>Follow steps below to start using <a target="_blank" href="https://compound.finance/">Compound Protocol</a><br />
					<a href="#faq">faq</a></p>
					<ul class="actions">
						<li><a href="" onclick="connectWallet();return false;" class="button icon solid fa-chevron-right">1. Connect wallet</a></li>
						<li><a href="#supply" class="button icon solid fa-chevron-down scrolly">2. Supply</a></li>
						<li><a href="#borrow" class="button icon solid fa-chevron-down scrolly">3. Borrow</a></li>
					</ul>
					<div class="col-12">
						<span>
							<label id="walletMsg">no wallet connected ... </label>
						</span>
					</div>
					<div>&nbsp;</div>
					<div class="innner table-wrapper">
						<div class="col-3">
						<table id="supplyTable">
							<thead><tr><th>Supply Token</th><th>Amount</th><th>Interest</th></tr></thead>
							<tbody align="left"></tbody>
							<tfoot><tr><td colspan="2"></td><td id="total_collatoral"></td></tr></tfoot>
						</table>
					</div>
					</div>

					<div class="innner table-wrapper">
						<table id="borrowTable">
							<thead><tr><th>Borrow Token</th><th>Amount</th><th>Interest</th></tr></thead>
							<tbody align="left"></tbody>
							<tfoot><tr><td colspan="2"></td><td id="total_borrow"></td></tr></tfoot>
						</table>
					</div>


				</div>
				<div class="image phone"><div class="inner"><img src="/images/screen2.jpg" alt="" /></div></div>
			</header>

		<!-- Supply -->
			<section id="supply" class="wrapper">
				<div class="inner">
					<section>		
							<h2>Supply market</h2>			

							<div class="innner table-wrapper">
								<div class="col-6">
								<table id="supplyAPY">
									<thead><tr><th>Supply Token</th><th>APY</th><th>Collateral factor</th><th>Total supply</th></tr></thead>
									<tbody align="left" ></tbody>
								</table>
							</div>

							<div class="row gtr-uniform">		
									<div class="col-12">	
										<h4>1. Supply token to the Compound Protocol:</h4>	
									</div>
									<div class="col-3 col-12-xsmall">
										<select name="category" id="supplyTokenChoice">
											<option value="ETH" selected>ETH</option>
										</select>
									</div>

									<div class="col-3 col-12-xsmall">
										<input type="text" id="supplyAmount" value placeholder="supply amount" />																			
									</div>
									<div class="col-3 col-12-xsmall">										
										<input type="submit" id="supplyButton" value="Supply" disabled />
									</div>

									<div class="col-12">
										<label id="supplyMsg"></label>
									</div>

									<div class="col-12">	
										<h4>2. Redeem from the Compound Protocol:</h4>	
									</div>

									<div class="col-3 col-12-xsmall">
										<select name="category" id="redeemTokenChoice">
											<option value="ETH" selected>ETH</option>
										</select>
									</div>

									<div class="col-3 col-12-xsmall">
										<input type="text" id="redeemAmount" value placeholder="redeem amount" />																			
									</div>
									<div class="col-3 col-12-xsmall">
										<input type="submit" id="redeemButton" value="Redeem" disabled/>
									</div>

									<div class="col-12">
										<label id="redeemMsg"></label>
									</div>

						  </div>
					</section>								
				</div>
			</section>

		<!-- Borrow -->
			<section id="borrow" class="wrapper">
				<div class="inner">
					<section>
							<h2>Borrow market</h2>			

							<div class="innner table-wrapper">
								<div class="col-6">
								<table id="borrowAPY">
									<thead><tr><th>Borrow Token</th><th>APY</th><th>Collateral factor</th><th>Total borrow</th></tr></thead>
									<tbody align="left" ></tbody>
								</table>
							</div>

						<div class="row gtr-uniform">	
									<div class="col-12">	
										<h4>1. Enter market (<a href="#faq">Collateral</a> required):</h4>	
									</div>
									<div class="col-3 col-12-xsmall">
										<select name="category" id="enterTokenChoice">
											<option value="ETH" selected>ETH</option>
										</select>
									</div>

									<div class="col-3 col-12-xsmall">
										<input type="submit" id="enterButton" value="Enter Market" disabled/>
									</div>
									<div class="col-12">
										<label id="enterMsg"></label>
									</div>

									<!--Borrow -->
									<div class="col-12">	
										<h4>2. Borrow from the Compound Protocol:</h4>	
									</div>
									<div class="col-3 col-12-xsmall">
										<select name="category" id="borrowTokenChoice">
											<option value="ETH" selected>ETH</option>
										</select>
									</div>

									<div class="col-3 col-12-xsmall">
										<input type="text" id="borrowAmount" />																			
									</div>
									<div class="col-3 col-12-xsmall">
										<input type="submit" id="borrowButton" value="Borrow" disabled/>
									</div>

									<div class="col-12">
										<label id="borrowMsg"></label>
									</div>

									<!--Repay Borrow -->
									<div class="col-12">	
										<h4>3. Repay borrow:</h4>	
									</div>
									<div class="col-3 col-12-xsmall">
										<select name="category" id="repayBorrowTokenChoice">
											<option value="ETH" selected>ETH</option>
										</select>
									</div>

									<div class="col-3 col-12-xsmall">
										<input type="text" id="repayBorrowAmount" />
									</div>
									<div class="col-3 col-12-xsmall">
										<input type="submit" id="repayBorrowButton" value="Repay Borrow" disabled/>
									</div>

									<div class="col-12">
										<label id="repayMsg"></label>
									</div>

									<div class="col-12">	
										<h4>4. Exit market:</h4>	
									</div>
									<div class="col-3 col-12-xsmall">
										<select name="category" id="exitTokenChoice">
											<option value="ETH" selected>ETH</option>
										</select>
									</div>

									<div class="col-3 col-12-xsmall">
										<input type="submit" id="exitButton" value="Exit Market" disabled/>
									</div>
									<div class="col-12">
										<label id="exitMsg"></label>
									</div>									
						</div>
					</section>
				</div>
			</section>

		<!-- FAQ -->

			<section id="faq" class="wrapper">
				<div class="inner">
					<section>
						<h4>FAQ</h4>
						<div class="row">
							<div class="col-12 col-12-medium">
								<h5>How to test?</h5>
								<ul>
									<li>Download metamask browser plugin at metamask.io</li>
									<li>For metamask app, open this page in metamask browser</li>
									<li>Open metamask, set your network to 'Kovan Test Network'or any other network</li>
									<li>Go to faucet.metamask.io or faucet.kovan.network to get a free test ETH token</li>
									<li>Click "1. Connection wallet"</li>
									<li>To supply, enter 0.5 ETH and click on supply button</li>
									<li>To borrow, first enter market, then select a token like DAI, enter amount like 5 and submit</li>
								</ul>

								<h5>How does collateral work?</h5>
								<ul>
									<li>Only needed if you borrow from Compound</li>
									<li>Let's say you have ETH and supply 10 ETH as collateral</li>
									<li>ETH's market price is $380, so you have about $3800</li>
									<li>with collateral factor of 75%, you can borrow up to $3800*0.75 = $2850 worth of DAI </li>									
								</ul>
							</div>
						</section>
					</div>
				</section>

		<!-- Footer -->
			<footer id="footer">
				<ul class="icons">
					<li><a href="#" class="icon brands fa-facebook-f"><span class="label">Facebook</span></a></li>
					<li><a href="#" class="icon brands fa-twitter"><span class="label">Twitter</span></a></li>
					<li><a href="#" class="icon brands fa-instagram"><span class="label">Instagram</span></a></li>
				</ul>
				<p class="copyright">&copy; Mensun &amp; David, source code: <a target=_blank href="https://github.com/compound-finance/compound-protocol">github</a></p>

				<p>&nbsp;</p>
				<p>&nbsp;</p>
				<p>&nbsp;</p>
				<p>&nbsp;</p>
				<p>&nbsp;</p>
				<p>&nbsp;</p>
			</footer>

		<!-- Scripts -->
			<script src="assets/js/jquery.min.js"></script>
			<script src="assets/js/jquery.scrolly.min.js"></script>
			<script src="assets/js/browser.min.js"></script>
			<script src="assets/js/breakpoints.min.js"></script>
			<script src="assets/js/util.js"></script>
			<script src="assets/js/main.js"></script>

			<script src="assets/js/myutil.js"></script> <!-- this util is used by the following codes -->
			<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@compound-finance/compound-js@0.2.1/dist/browser/compound.min.js"></script>

			<script type="text/javascript">	
				const alltokens = ["COMP","DAI","USDC","USDT","WBTC","UNI","BAT","ZRX","REP","SAI"];
				const allselects = ["supplyTokenChoice","redeemTokenChoice","enterTokenChoice","borrowTokenChoice","repayBorrowTokenChoice","exitTokenChoice"];
				addOptionsToSelect(allselects, alltokens); //auto populate the options in selections

				//compound name mapping to Compound object used in the API call
				const compoundTokenMap = {
				  "ETH": Compound.ETH,  "cETH": Compound.cETH,	"DAI": Compound.DAI,  "cDAI": Compound.cDAI,
				  "cUSDC": Compound.cUSDC, "cUNI": Compound.cUNI, "cWBTC": Compound.cWBTC, "cUSDT": Compound.cUSDT,
				  "cZRX": Compound.cZRX, "USDC": Compound.USDC, "UNI": Compound.UNI, "WBTC": Compound.WBTC,
				  "USDT": Compound.USDT, "ZRX": Compound.ZRX			  
				};

				var provider=window.ethereum;
				var walletAddress=null;
				var networkName=null;
				var total_borrow_value_in_eth=0;
				var total_collateral_value_in_eth=0;
				var borrowToken = {};
				var supplyToken = {};

				//populate market info with token, APY, collateral factor, and total
				var supplyAPY = document.getElementById("supplyAPY");
				var borrowAPY = document.getElementById("borrowAPY");
				showTokenMarket(supplyAPY, borrowAPY); 


				function connectWallet() {
					//Connect wallet and invoke functions that require wallet addresses
					if (walletAddress!=null) { return; }
					document.getElementById('walletMsg').innerHTML = 'Waiting for wallet connection ...';									

					provider.enable().then( function(result) {
						walletAddress = result[0];						
						enableButtons();						
						networkName=Compound.util.getNetNameWithChainId(parseInt(provider.chainId));
						document.getElementById('walletMsg').innerHTML = 'wallet: ' + walletAddress + ', ' + networkName;
						console.log('walletAddress:', walletAddress, networkName);

						//show supply/borrow token,amount, interest on front page
						showAccountInfo(); 

						//still testing:
						(async function () {
						  console.log('walletAddress:', walletAddress, typeof(walletAddress));
						  console.log('provider:', provider);
						  balance = await Compound.eth.getBalance(walletAddress, provider);
						  console.log('My ETH Balance', +balance/1e18);

						})().catch(console.error);

					});		
				}

				function enableButtons() {
					//enable button is called after wallet connection
					//these are the basic functions needed for each supply/borrow actions
				  const supplyButton = document.getElementById('supplyButton');
				  const redeemButton = document.getElementById('redeemButton');				  
				  const enterButton = document.getElementById('enterButton');				  
				  const exitButton = document.getElementById('exitButton');				  
				  const borrowButton = document.getElementById('borrowButton');
				  const repayBorrowButton = document.getElementById('repayBorrowButton');
				  supplyButton.disabled = false;
				  redeemButton.disabled = false;
				  enterButton.disabled = false;
				  exitButton.disabled = false;
				  borrowButton.disabled = false;
				  repayBorrowButton.disabled = false;

				  provider.enable().then(() => {
				    const compound = new Compound(provider);

				    //enter compound market
				    const doEnter = async () => {			
				    	const enterTokenName = document.getElementById('enterTokenChoice').value;
				      const trx = await compound.enterMarkets(compoundTokenMap[enterTokenName]); // Use [] for multiple
				      await trx.wait(1);
	  					console.log('transaction object', trx);
				    }; enterButton.onclick = doEnter;

				    //exit compound market
				    const doExit = async () => {			
				    	const exitTokenName = document.getElementById('exitTokenChoice').value;
				      const trx = await compound.exitMarkets(compoundTokenMap[enterTokenName]); // Use [] for multiple
				      await trx.wait(1);
	  					console.log('transaction object', trx);
				    }; enterButton.onclick = doEnter;

				    //Supply tokens to compound market
				    const doSupply = async () => {			
				      const tokenToSupply = document.getElementById('supplyAmount');
				      const supplyTokenName = document.getElementById('supplyTokenChoice').value;
				      console.log('tokenToSupply', tokenToSupply);
				      const trx = await compound.supply(compoundTokenMap[supplyTokenName], tokenToSupply.value);
				      document.getElementById('supplyMsg').innerHTML = 'Waiting for confirmation ...';
				      await trx.wait(1);				    
				      document.getElementById('supplyMsg').innerHTML = 'Supply success';
				      console.log('trx', trx);
				    }; supplyButton.onclick = doSupply;
					
				    //Redeem tokenns from compound market
				    const doRedeem = async () => {
				      const tokenToRedeem = document.getElementById('redeemAmount');
				      const redeemTokenName = 'c'+document.getElementById('redeemTokenChoice').value;
				      console.log('tokenToRedeem', compoundTokenMap[redeemTokenName]);
				      const trx = await compound.redeem(compoundTokenMap[redeemTokenName], tokenToRedeem.value);
				      document.getElementById('redeemMsg').innerHTML = 'Waiting for confirmation ...';
				      await trx.wait(1);				    
				      document.getElementById('redeemMsg').innerHTML = 'Reedem success';
				      console.log('trx', trx);
				    }; redeemButton.onclick = doRedeem;
					
				    //Borrow tokens
					  const doBorrow = async () => {
				      const tokenToBorrow = document.getElementById('borrowAmount');
				      const borrowTokenName = document.getElementById('borrowTokenChoice').value;
				      const trx = await compound.borrow(compoundTokenMap[borrowTokenName], tokenToBorrow.value);
				      document.getElementById('borrowMsg').innerHTML = 'Waiting for confirmation ...';
				      await trx.wait(1);				    
				      document.getElementById('borrowMsg').innerHTML = 'Borrow success';
				      console.log('trx', trx);
				    }; borrowButton.onclick = doBorrow;

				  	//Repay borrow, catches an error
						const doRepayBorrow = async () => {
						try {
							const tokenToRepay = document.getElementById('repayBorrowAmount');	
							const repayBorrowTokenName = document.getElementById('repayBorrowTokenChoice').value;					
							const trx = await compound.repayBorrow(compoundTokenMap[repayBorrowTokenName], tokenToRepay.value, null);
					        document.getElementById('repayMsg').innerHTML = 'Waiting for confirmation ...';
					        await trx.wait(1);				    
					        document.getElementById('repayMsg').innerHTML = 'Repay Borrow success';
					        console.log('trx', trx);
					   	} catch(err) {
									console.log(err);
									alert(err.message);
						}}; repayBorrowButton.onclick = doRepayBorrow;

				  });
				}

				function showAccountInfo() {
					//read cTokens from compound market and show on supply/borrow market
					(async function() {
					  const account = await Compound.api.account({
					    "addresses": walletAddress,
					    "network": networkName
					  });
					  
					  if (Object.isExtensible(account) && account.accounts) {
					    account.accounts.forEach((acc) => {
					    	total_borrow_value_in_eth = acc.total_borrow_value_in_eth.value;
					    	total_collateral_value_in_eth = acc.total_collateral_value_in_eth.value;					    	

					      acc.tokens.forEach((tok) => {
					      	console.log('tok', tok);
					      	val = tok.borrow_balance_underlying.value;
					      	if (val>0.001) {
					      		borrowToken[tok.symbol] = val;
					      		interest = tok.lifetime_borrow_interest_accrued.value;
					      		tableAddRow(document.getElementById("borrowTable"),[withImage(tok.symbol), mathr(val, 4), mathr(interest,4)] );
					      	}	
					      	val2 = tok.supply_balance_underlying.value;
					      	if (val2>0.001) {
					      		supplyToken[tok.symbol] = val2;
					      		interest2 = tok.lifetime_supply_interest_accrued.value;
					      		tableAddRow(document.getElementById("supplyTable"), [withImage(tok.symbol), mathr(val2, 4), mathr(interest2,4)] );
					      	}
					      });
					    });
					    document.getElementById('total_collatoral').innerHTML = 'Total Collateral: ' + mathr(total_collateral_value_in_eth, 4) + ' ETH';
					    document.getElementById('total_borrow').innerHTML = 'Total Borrow: ' + mathr(total_borrow_value_in_eth, 4) + ' ETH';

					    console.log(supplyToken);
					    console.log(borrowToken);
					  }

					})().catch(console.error);					
				}

			</script>

	</body>
</html>